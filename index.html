<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Todoist â€” Hub City Design</title>
  <link href="https://integrations.missiveapp.com/missive.css" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #1f1f1f;
      --bg-secondary: #282828;
      --bg-tertiary: #363636;
      --bg-hover: #404040;
      --text-primary: #e8e8e8;
      --text-secondary: #a0a0a0;
      --text-muted: #666;
      --border-color: #404040;
      --accent: #dc4c3e;
      --accent-hover: #c53727;
      --green: #058527;
      --orange: #eb8909;
      --blue: #246fe0;
      --p1: #d1453b;
      --p2: #eb8909;
      --p3: #246fe0;
      --p4: #666;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 14px;
      line-height: 1.5;
      height: 100vh;
      overflow: hidden;
    }

    /* Main Layout */
    .app {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .menu-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 6px;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .menu-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .header-title {
      font-size: 16px;
      font-weight: 600;
    }

    .header-actions {
      display: flex;
      gap: 8px;
    }

    .icon-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 6px;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .icon-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    /* Navigation Drawer */
    .nav-drawer {
      position: fixed;
      top: 0;
      left: -280px;
      width: 280px;
      height: 100%;
      background: var(--bg-secondary);
      z-index: 100;
      transition: left 0.2s ease;
      display: flex;
      flex-direction: column;
    }

    .nav-drawer.open {
      left: 0;
    }

    .nav-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 99;
      display: none;
    }

    .nav-overlay.open {
      display: block;
    }

    .nav-header {
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .nav-user {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
    }

    .nav-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      cursor: pointer;
      color: var(--text-primary);
      font-size: 14px;
      border: none;
      background: transparent;
      width: 100%;
      text-align: left;
    }

    .nav-item:hover {
      background: var(--bg-hover);
    }

    .nav-item.active {
      background: var(--bg-tertiary);
    }

    .nav-item .icon {
      font-size: 16px;
      width: 24px;
      text-align: center;
    }

    .nav-item .count {
      margin-left: auto;
      color: var(--text-secondary);
      font-size: 12px;
    }

    .nav-section-title {
      padding: 16px 16px 8px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .project-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    /* Main Content */
    .main {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .view-header {
      margin-bottom: 16px;
    }

    .view-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .view-subtitle {
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* Task List */
    .task-section {
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 8px;
    }

    .section-title.overdue {
      color: var(--p1);
    }

    .task-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      margin-bottom: 4px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.1s;
    }

    .task-item:hover {
      background: var(--bg-secondary);
    }

    .checkbox {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid var(--p4);
      background: transparent;
      cursor: pointer;
      flex-shrink: 0;
      margin-top: 2px;
      transition: all 0.15s;
    }

    .checkbox:hover {
      background: var(--bg-tertiary);
    }

    .checkbox.p1 { border-color: var(--p1); }
    .checkbox.p2 { border-color: var(--p2); }
    .checkbox.p3 { border-color: var(--p3); }

    .checkbox.completing {
      background: var(--green);
      border-color: var(--green);
    }

    .task-body {
      flex: 1;
      min-width: 0;
    }

    .task-title {
      font-size: 14px;
      color: var(--text-primary);
      margin-bottom: 6px;
      word-break: break-word;
    }

    .task-title.completing {
      text-decoration: line-through;
      color: var(--text-secondary);
    }

    .task-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .task-due {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .task-due.overdue { color: var(--p1); }
    .task-due.today { color: var(--green); }

    .task-project {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .task-project .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    /* Add Task */
    .add-task-row {
      padding: 12px;
      cursor: pointer;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 12px;
      border-radius: 8px;
    }

    .add-task-row:hover {
      background: var(--bg-secondary);
      color: var(--accent);
    }

    .add-task-row .plus {
      color: var(--accent);
      font-size: 18px;
      font-weight: 500;
    }

    /* Task Detail Overlay */
    .detail-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-primary);
      z-index: 50;
      display: none;
      flex-direction: column;
    }

    .detail-overlay.open {
      display: flex;
    }

    .detail-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
    }

    .detail-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      font-size: 13px;
    }

    .detail-header-left .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .detail-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .detail-checkbox-row {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 20px;
    }

    .detail-title {
      flex: 1;
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
      background: transparent;
      border: none;
      width: 100%;
      resize: none;
      line-height: 1.4;
    }

    .detail-title:focus {
      outline: none;
    }

    .detail-description {
      width: 100%;
      min-height: 100px;
      font-size: 14px;
      line-height: 1.6;
      color: var(--text-primary);
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      resize: vertical;
      margin-bottom: 20px;
    }

    .detail-description:focus {
      outline: none;
      border-color: var(--accent);
    }

    .detail-meta {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
    }

    .meta-row:not(:last-child) {
      border-bottom: 1px solid var(--border-color);
    }

    .meta-label {
      color: var(--text-secondary);
      font-size: 13px;
    }

    .meta-value {
      color: var(--text-primary);
      font-size: 13px;
    }

    /* Comments */
    .comments {
      border-top: 1px solid var(--border-color);
      padding-top: 20px;
    }

    .comments-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .comment-list {
      margin-bottom: 16px;
    }

    .comment-item {
      background: var(--bg-secondary);
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .comment-text {
      font-size: 14px;
      color: var(--text-primary);
      margin-bottom: 4px;
      line-height: 1.5;
    }

    .comment-date {
      font-size: 11px;
      color: var(--text-muted);
    }

    .comment-input-row {
      display: flex;
      gap: 8px;
    }

    .comment-input {
      flex: 1;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 14px;
      resize: none;
    }

    .comment-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .btn {
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-complete {
      background: var(--green);
      color: #fff;
      width: 100%;
      margin-top: 20px;
      padding: 14px;
    }

    /* Add Task Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 150;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal {
      background: var(--bg-secondary);
      border-radius: 12px;
      width: 100%;
      max-width: 400px;
      overflow: hidden;
    }

    .modal-header {
      padding: 16px;
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
    }

    .modal-body {
      padding: 16px;
    }

    .input-group {
      margin-bottom: 12px;
    }

    .input-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 6px;
      display: block;
    }

    .text-input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 14px;
    }

    .text-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .select-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .select-btn {
      flex: 1;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      text-align: center;
    }

    .select-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .select-btn.active {
      border-color: var(--accent);
      color: var(--accent);
    }

    .modal-footer {
      padding: 16px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .btn-cancel {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
    }

    .btn-cancel:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    /* Auth */
    .auth {
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      text-align: center;
    }

    .auth-logo {
      width: 64px;
      height: 64px;
      margin-bottom: 20px;
    }

    .auth-title {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .auth-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 24px;
      max-width: 280px;
    }

    .auth-input {
      width: 100%;
      max-width: 300px;
      padding: 14px 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 14px;
      margin-bottom: 12px;
    }

    .auth-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .auth-btn {
      width: 100%;
      max-width: 300px;
      padding: 14px;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    .auth-btn:hover {
      background: var(--accent-hover);
    }

    .auth-help {
      margin-top: 16px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .auth-help a {
      color: var(--accent);
    }

    /* Utilities */
    .hidden { display: none !important; }
    
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
    }

    .spinner {
      width: 28px;
      height: 28px;
      border: 3px solid var(--border-color);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .empty-icon {
      font-size: 40px;
      margin-bottom: 12px;
    }
  </style>
</head>
<body>

<!-- Auth Screen -->
<div id="auth" class="auth">
  <svg class="auth-logo" viewBox="0 0 100 100">
    <circle cx="50" cy="50" r="45" fill="#dc4c3e"/>
    <path d="M30 50 L45 65 L70 35" stroke="#fff" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
  </svg>
  <h1 class="auth-title">Connect Todoist</h1>
  <p class="auth-subtitle">Enter your API token to access tasks in Missive.</p>
  <input type="password" id="token-input" class="auth-input" placeholder="Paste your API token">
  <button id="connect-btn" class="auth-btn">Connect</button>
  <p class="auth-help">
    <a href="https://todoist.com/app/settings/integrations/developer" target="_blank">Get API token â†’</a>
  </p>
</div>

<!-- Main App -->
<div id="app" class="app hidden">
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <button class="menu-btn" id="menu-btn">â˜°</button>
      <span class="header-title" id="header-title">Today</span>
    </div>
    <div class="header-actions">
      <button class="icon-btn" id="add-btn" title="Add Task">ï¼‹</button>
      <button class="icon-btn" id="refresh-btn" title="Refresh">â†»</button>
      <button class="icon-btn" id="logout-btn" title="Disconnect">âš™</button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main" id="main">
    <div class="loading"><div class="spinner"></div></div>
  </div>
</div>

<!-- Nav Drawer -->
<div class="nav-overlay" id="nav-overlay"></div>
<div class="nav-drawer" id="nav-drawer">
  <div class="nav-header">
    <div class="nav-user">
      <div class="avatar">D</div>
      <span>Dillon</span>
    </div>
    <button class="icon-btn" id="close-nav">âœ•</button>
  </div>
  <div class="nav-content" id="nav-content"></div>
</div>

<!-- Task Detail Overlay -->
<div class="detail-overlay" id="detail-overlay">
  <div class="detail-header">
    <div class="detail-header-left">
      <span class="dot" id="detail-dot"></span>
      <span id="detail-project-name">Inbox</span>
    </div>
    <div>
      <button class="icon-btn" id="open-external" title="Open in Todoist">â†—</button>
      <button class="icon-btn" id="close-detail">âœ•</button>
    </div>
  </div>
  <div class="detail-content">
    <div class="detail-checkbox-row">
      <button class="checkbox" id="detail-checkbox"></button>
      <textarea class="detail-title" id="detail-title" rows="1"></textarea>
    </div>
    
    <textarea class="detail-description" id="detail-description" placeholder="Add description..."></textarea>
    
    <div class="detail-meta">
      <div class="meta-row">
        <span class="meta-label">Due date</span>
        <span class="meta-value" id="detail-due">No date</span>
      </div>
      <div class="meta-row">
        <span class="meta-label">Priority</span>
        <span class="meta-value" id="detail-priority">P4</span>
      </div>
      <div class="meta-row">
        <span class="meta-label">Labels</span>
        <span class="meta-value" id="detail-labels">None</span>
      </div>
    </div>

    <div class="comments">
      <div class="comments-title">Comments</div>
      <div class="comment-list" id="comment-list"></div>
      <div class="comment-input-row">
        <textarea class="comment-input" id="comment-input" rows="2" placeholder="Write a comment..."></textarea>
        <button class="btn btn-primary" id="send-comment">Send</button>
      </div>
    </div>

    <button class="btn btn-complete" id="complete-btn">âœ“ Mark Complete</button>
  </div>
</div>

<!-- Add Task Modal -->
<div class="modal-overlay" id="add-modal">
  <div class="modal">
    <div class="modal-header">Add Task</div>
    <div class="modal-body">
      <div class="input-group">
        <label class="input-label">Task name</label>
        <input type="text" class="text-input" id="new-title" placeholder="What needs to be done?">
      </div>
      <div class="input-group">
        <label class="input-label">Description (optional)</label>
        <textarea class="text-input" id="new-desc" rows="2" placeholder="Add details..."></textarea>
      </div>
      <div class="input-group">
        <label class="input-label">Due date</label>
        <div class="select-row">
          <button class="select-btn" data-due="today">Today</button>
          <button class="select-btn" data-due="tomorrow">Tomorrow</button>
          <button class="select-btn" data-due="next week">Next week</button>
        </div>
      </div>
      <div class="input-group">
        <label class="input-label">Priority</label>
        <div class="select-row">
          <button class="select-btn" data-priority="1" style="color:var(--p1)">P1</button>
          <button class="select-btn" data-priority="2" style="color:var(--p2)">P2</button>
          <button class="select-btn" data-priority="3" style="color:var(--p3)">P3</button>
          <button class="select-btn active" data-priority="4">P4</button>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-cancel" id="cancel-add">Cancel</button>
      <button class="btn btn-primary" id="save-add">Add Task</button>
    </div>
  </div>
</div>

<script src="https://integrations.missiveapp.com/missive.js"></script>
<script>
  // State
  let token = null;
  let tasks = [];
  let projects = [];
  let currentView = 'today';
  let currentProjectId = null;
  let selectedTask = null;
  let newTask = { due: null, priority: 4 };

  // Elements
  const $ = id => document.getElementById(id);
  const auth = $('auth');
  const app = $('app');
  const main = $('main');
  const navDrawer = $('nav-drawer');
  const navOverlay = $('nav-overlay');
  const detailOverlay = $('detail-overlay');
  const addModal = $('add-modal');

  // Init
  async function init() {
    try {
      token = typeof Missive !== 'undefined' 
        ? await Missive.storeGet('todoist_token')
        : localStorage.getItem('todoist_token');
      
      if (token) {
        showApp();
        await loadData();
      } else {
        showAuth();
      }
    } catch (e) {
      console.error(e);
      showAuth();
    }
  }

  function showAuth() {
    auth.classList.remove('hidden');
    app.classList.add('hidden');
  }

  function showApp() {
    auth.classList.add('hidden');
    app.classList.remove('hidden');
  }

  // Auth
  $('connect-btn').onclick = async () => {
    const t = $('token-input').value.trim();
    if (!t) return;

    $('connect-btn').textContent = 'Connecting...';
    try {
      const res = await fetch('https://api.todoist.com/rest/v2/projects', {
        headers: { 'Authorization': `Bearer ${t}` }
      });
      if (!res.ok) throw new Error();

      if (typeof Missive !== 'undefined') {
        await Missive.storeSet('todoist_token', t);
      } else {
        localStorage.setItem('todoist_token', t);
      }

      token = t;
      showApp();
      await loadData();
    } catch (e) {
      alert('Invalid token');
      $('connect-btn').textContent = 'Connect';
    }
  };

  $('logout-btn').onclick = async () => {
    if (!confirm('Disconnect?')) return;
    if (typeof Missive !== 'undefined') {
      await Missive.storeSet('todoist_token', null);
    } else {
      localStorage.removeItem('todoist_token');
    }
    token = null;
    showAuth();
  };

  // API
  async function api(endpoint, opts = {}) {
    const res = await fetch(`https://api.todoist.com/rest/v2${endpoint}`, {
      ...opts,
      headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json', ...opts.headers }
    });
    if (!res.ok) throw new Error(res.status);
    const text = await res.text();
    return text ? JSON.parse(text) : null;
  }

  async function loadData() {
    main.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    try {
      [projects, tasks] = await Promise.all([api('/projects'), api('/tasks')]);
      renderNav();
      renderTasks();
    } catch (e) {
      main.innerHTML = '<div class="empty">Failed to load</div>';
    }
  }

  $('refresh-btn').onclick = loadData;

  // Navigation
  function renderNav() {
    const inbox = projects.find(p => p.is_inbox_project);
    const todayCount = getTodayTasks().length;
    const inboxCount = tasks.filter(t => t.project_id === inbox?.id).length;

    let html = `
      <button class="nav-item ${currentView === 'today' ? 'active' : ''}" data-view="today">
        <span class="icon">ðŸ“…</span> Today ${todayCount ? `<span class="count">${todayCount}</span>` : ''}
      </button>
      <button class="nav-item ${currentView === 'upcoming' ? 'active' : ''}" data-view="upcoming">
        <span class="icon">ðŸ“†</span> Upcoming
      </button>
      <button class="nav-item ${currentView === 'inbox' ? 'active' : ''}" data-view="inbox">
        <span class="icon">ðŸ“¥</span> Inbox ${inboxCount ? `<span class="count">${inboxCount}</span>` : ''}
      </button>
      <div class="nav-section-title">Projects</div>
    `;

    projects.filter(p => !p.is_inbox_project).forEach(p => {
      const count = tasks.filter(t => t.project_id === p.id).length;
      const isActive = currentView === 'project' && currentProjectId === p.id;
      html += `
        <button class="nav-item ${isActive ? 'active' : ''}" data-view="project" data-project="${p.id}">
          <span class="project-dot" style="background:${getColor(p.color)}"></span>
          ${esc(p.name)}
          ${count ? `<span class="count">${count}</span>` : ''}
        </button>
      `;
    });

    $('nav-content').innerHTML = html;

    $('nav-content').querySelectorAll('.nav-item').forEach(el => {
      el.onclick = () => {
        currentView = el.dataset.view;
        currentProjectId = el.dataset.project || null;
        renderTasks();
        closeNav();
      };
    });
  }

  function getTodayTasks() {
    const today = new Date(); today.setHours(0,0,0,0);
    return tasks.filter(t => t.due && new Date(t.due.date) <= today);
  }

  // Nav drawer
  $('menu-btn').onclick = () => {
    navDrawer.classList.add('open');
    navOverlay.classList.add('open');
  };

  function closeNav() {
    navDrawer.classList.remove('open');
    navOverlay.classList.remove('open');
  }

  $('close-nav').onclick = closeNav;
  navOverlay.onclick = closeNav;

  // Render Tasks
  function renderTasks() {
    const today = new Date(); today.setHours(0,0,0,0);
    let filtered = [];
    let title = '';

    switch (currentView) {
      case 'today':
        filtered = getTodayTasks();
        title = 'Today';
        break;
      case 'upcoming':
        filtered = tasks.filter(t => t.due).sort((a, b) => new Date(a.due.date) - new Date(b.due.date));
        title = 'Upcoming';
        break;
      case 'inbox':
        const inbox = projects.find(p => p.is_inbox_project);
        filtered = tasks.filter(t => t.project_id === inbox?.id);
        title = 'Inbox';
        break;
      case 'project':
        const proj = projects.find(p => p.id === currentProjectId);
        filtered = tasks.filter(t => t.project_id === currentProjectId);
        title = proj?.name || 'Project';
        break;
    }

    $('header-title').textContent = title;

    if (!filtered.length) {
      main.innerHTML = `
        <div class="view-header">
          <h1 class="view-title">${title}</h1>
        </div>
        <div class="empty">
          <div class="empty-icon">âœ“</div>
          <div>All clear!</div>
        </div>
        <div class="add-task-row" id="add-inline"><span class="plus">+</span> Add task</div>
      `;
      $('add-inline').onclick = openAddModal;
      return;
    }

    // Sort
    filtered.sort((a, b) => {
      if (a.priority !== b.priority) return b.priority - a.priority;
      if (a.due && b.due) return new Date(a.due.date) - new Date(b.due.date);
      return a.due ? -1 : 1;
    });

    // Group for Today view
    let html = `<div class="view-header"><h1 class="view-title">${title}</h1></div>`;

    if (currentView === 'today') {
      const overdue = filtered.filter(t => { const d = new Date(t.due.date); d.setHours(0,0,0,0); return d < today; });
      const todayTasks = filtered.filter(t => { const d = new Date(t.due.date); d.setHours(0,0,0,0); return d.getTime() === today.getTime(); });

      if (overdue.length) {
        html += `<div class="task-section"><div class="section-title overdue">Overdue (${overdue.length})</div>`;
        overdue.forEach(t => html += taskHTML(t));
        html += '</div>';
      }
      if (todayTasks.length) {
        html += `<div class="task-section"><div class="section-title">Today</div>`;
        todayTasks.forEach(t => html += taskHTML(t));
        html += '</div>';
      }
    } else {
      html += '<div class="task-section">';
      filtered.forEach(t => html += taskHTML(t));
      html += '</div>';
    }

    html += `<div class="add-task-row" id="add-inline"><span class="plus">+</span> Add task</div>`;
    main.innerHTML = html;

    // Event listeners
    main.querySelectorAll('.checkbox').forEach(cb => {
      cb.onclick = e => { e.stopPropagation(); completeTask(cb.dataset.id); };
    });

    main.querySelectorAll('.task-item').forEach(el => {
      el.onclick = () => openDetail(el.dataset.id);
    });

    $('add-inline').onclick = openAddModal;
  }

  function taskHTML(t) {
    const proj = projects.find(p => p.id === t.project_id);
    const due = getDue(t.due);
    return `
      <div class="task-item" data-id="${t.id}">
        <button class="checkbox p${t.priority}" data-id="${t.id}"></button>
        <div class="task-body">
          <div class="task-title">${esc(t.content)}</div>
          <div class="task-meta">
            ${due ? `<span class="task-due ${due.cls}">${due.text}</span>` : ''}
            ${currentView !== 'project' && proj ? `<span class="task-project"><span class="dot" style="background:${getColor(proj.color)}"></span>${esc(proj.name)}</span>` : ''}
          </div>
        </div>
      </div>
    `;
  }

  async function completeTask(id) {
    const item = main.querySelector(`.task-item[data-id="${id}"]`);
    const cb = main.querySelector(`.checkbox[data-id="${id}"]`);
    const title = item?.querySelector('.task-title');

    if (cb) cb.classList.add('completing');
    if (title) title.classList.add('completing');

    try {
      await api(`/tasks/${id}/close`, { method: 'POST' });
      tasks = tasks.filter(t => t.id !== id);
      setTimeout(() => {
        renderTasks();
        renderNav();
        if (selectedTask?.id === id) closeDetail();
      }, 300);
    } catch (e) {
      if (cb) cb.classList.remove('completing');
      if (title) title.classList.remove('completing');
    }
  }

  // Task Detail
  function openDetail(id) {
    selectedTask = tasks.find(t => t.id === id);
    if (!selectedTask) return;

    const proj = projects.find(p => p.id === selectedTask.project_id);

    $('detail-dot').style.background = getColor(proj?.color || 'grey');
    $('detail-project-name').textContent = proj?.name || 'Inbox';
    $('detail-title').value = selectedTask.content;
    $('detail-description').value = selectedTask.description || '';
    $('detail-checkbox').className = `checkbox p${selectedTask.priority}`;

    const due = getDue(selectedTask.due);
    $('detail-due').textContent = due ? due.text : 'No date';
    $('detail-priority').textContent = `P${5 - selectedTask.priority}`;
    $('detail-labels').textContent = selectedTask.labels.length ? selectedTask.labels.map(l => '@'+l).join(', ') : 'None';

    loadComments(id);
    detailOverlay.classList.add('open');
  }

  function closeDetail() {
    detailOverlay.classList.remove('open');
    selectedTask = null;
  }

  $('close-detail').onclick = closeDetail;

  $('open-external').onclick = () => {
    if (selectedTask) window.open(`https://todoist.com/app/task/${selectedTask.id}`, '_blank');
  };

  $('detail-checkbox').onclick = () => {
    if (selectedTask) completeTask(selectedTask.id);
  };

  $('complete-btn').onclick = () => {
    if (selectedTask) completeTask(selectedTask.id);
  };

  // Save on blur
  $('detail-title').onblur = async () => {
    if (!selectedTask) return;
    const val = $('detail-title').value.trim();
    if (val && val !== selectedTask.content) {
      await api(`/tasks/${selectedTask.id}`, { method: 'POST', body: JSON.stringify({ content: val }) });
      selectedTask.content = val;
      renderTasks();
    }
  };

  $('detail-description').onblur = async () => {
    if (!selectedTask) return;
    const val = $('detail-description').value;
    if (val !== (selectedTask.description || '')) {
      await api(`/tasks/${selectedTask.id}`, { method: 'POST', body: JSON.stringify({ description: val }) });
      selectedTask.description = val;
    }
  };

  // Comments
  async function loadComments(id) {
    $('comment-list').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    try {
      const comments = await api(`/comments?task_id=${id}`);
      if (!comments.length) {
        $('comment-list').innerHTML = '<div style="color:var(--text-muted);font-size:13px;padding:8px 0;">No comments yet</div>';
      } else {
        $('comment-list').innerHTML = comments.map(c => `
          <div class="comment-item">
            <div class="comment-text">${esc(c.content)}</div>
            <div class="comment-date">${new Date(c.posted_at).toLocaleString()}</div>
          </div>
        `).join('');
      }
    } catch (e) {
      $('comment-list').innerHTML = '<div style="color:var(--text-muted)">Failed to load</div>';
    }
  }

  $('send-comment').onclick = async () => {
    if (!selectedTask) return;
    const content = $('comment-input').value.trim();
    if (!content) return;

    $('send-comment').disabled = true;
    try {
      await api('/comments', { method: 'POST', body: JSON.stringify({ task_id: selectedTask.id, content }) });
      $('comment-input').value = '';
      await loadComments(selectedTask.id);
      selectedTask.comment_count++;
      renderTasks();
    } catch (e) {}
    $('send-comment').disabled = false;
  };

  // Add Task
  function openAddModal() {
    newTask = { due: null, priority: 4 };
    $('new-title').value = '';
    $('new-desc').value = '';
    addModal.querySelectorAll('[data-due]').forEach(b => b.classList.remove('active'));
    addModal.querySelectorAll('[data-priority]').forEach(b => b.classList.toggle('active', b.dataset.priority === '4'));
    addModal.classList.add('open');
    $('new-title').focus();
  }

  function closeAddModal() {
    addModal.classList.remove('open');
  }

  $('add-btn').onclick = openAddModal;
  $('cancel-add').onclick = closeAddModal;
  addModal.onclick = e => { if (e.target === addModal) closeAddModal(); };

  addModal.querySelectorAll('[data-due]').forEach(btn => {
    btn.onclick = () => {
      addModal.querySelectorAll('[data-due]').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      newTask.due = btn.dataset.due;
    };
  });

  addModal.querySelectorAll('[data-priority]').forEach(btn => {
    btn.onclick = () => {
      addModal.querySelectorAll('[data-priority]').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      newTask.priority = parseInt(btn.dataset.priority);
    };
  });

  $('save-add').onclick = async () => {
    const content = $('new-title').value.trim();
    if (!content) return;

    $('save-add').textContent = 'Adding...';
    $('save-add').disabled = true;

    try {
      const body = { content };
      if ($('new-desc').value.trim()) body.description = $('new-desc').value.trim();
      if (newTask.due) body.due_string = newTask.due;
      if (newTask.priority !== 4) body.priority = newTask.priority;
      if (currentProjectId) body.project_id = currentProjectId;

      const t = await api('/tasks', { method: 'POST', body: JSON.stringify(body) });
      tasks.push(t);
      closeAddModal();
      renderTasks();
      renderNav();
    } catch (e) {
      alert('Failed to add');
    }

    $('save-add').textContent = 'Add Task';
    $('save-add').disabled = false;
  };

  // Helpers
  function getDue(due) {
    if (!due) return null;
    const today = new Date(); today.setHours(0,0,0,0);
    const d = new Date(due.date); d.setHours(0,0,0,0);
    const diff = Math.floor((d - today) / 86400000);

    if (diff < 0) return { text: `${Math.abs(diff)}d overdue`, cls: 'overdue' };
    if (diff === 0) return { text: 'Today', cls: 'today' };
    if (diff === 1) return { text: 'Tomorrow', cls: '' };
    if (diff <= 7) return { text: d.toLocaleDateString('en-US', { weekday: 'short' }), cls: '' };
    return { text: d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }), cls: '' };
  }

  function getColor(c) {
    const colors = { berry_red:'#b8256f', red:'#db4035', orange:'#ff9933', yellow:'#fad000', olive_green:'#afb83b', lime_green:'#7ecc49', green:'#299438', mint_green:'#6accbc', teal:'#158fad', sky_blue:'#14aaf5', light_blue:'#96c3eb', blue:'#4073ff', grape:'#884dff', violet:'#af38eb', lavender:'#eb96eb', magenta:'#e05194', salmon:'#ff8d85', charcoal:'#808080', grey:'#b8b8b8', taupe:'#ccac93' };
    return colors[c] || '#808080';
  }

  function esc(s) {
    const d = document.createElement('div');
    d.textContent = s || '';
    return d.innerHTML;
  }

  // Auto refresh
  setInterval(() => {
    if (token && !detailOverlay.classList.contains('open')) loadData();
  }, 60000);

  init();
</script>
</body>
</html>
